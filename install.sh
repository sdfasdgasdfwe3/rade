#!/bin/bash

# =============================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =============================================
REPO_URL="https://github.com/sdfasdgasdfwe3/rade.git"
REPO_DIR="$HOME/rade"
SCRIPT_NAME=$(basename "$0")

# =============================================
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
# =============================================
error_exit() {
    echo "–û–®–ò–ë–ö–ê: $1" >&2
    exit 1
}

# =============================================
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ git, –µ—Å–ª–∏ –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
# =============================================
install_git() {
    if ! command -v git &>/dev/null; then
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º git..."
        pkg install git -y || error_exit "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ git"
    fi
}

# =============================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# =============================================
install_deps() {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
    if ! command -v python3 &>/dev/null; then
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python3..."
        pkg install python -y || error_exit "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Python"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ pip
    if ! command -v pip3 &>/dev/null; then
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pip..."
        python3 -m ensurepip --upgrade || error_exit "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pip"
    fi

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip3 install -U requests telethon psutil || error_exit "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
}

# =============================================
# –†–∞–±–æ—Ç–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
# =============================================
setup_repo() {
    if [ -d "$REPO_DIR/.git" ]; then
        echo "–û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        cd "$REPO_DIR" && git pull || error_exit "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    else
        echo "–ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        git clone "$REPO_URL" "$REPO_DIR" || error_exit "–û—à–∏–±–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
        cd "$REPO_DIR" || error_exit "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
    fi
}

# =============================================
# –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
# =============================================
get_auth_data() {
    if [ -t 0 ]; then
        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        echo "üîë –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram:"
        read -p "üîë –í–≤–µ–¥–∏—Ç–µ API ID: " API_ID
        read -p "üîë –í–≤–µ–¥–∏—Ç–µ API HASH: " API_HASH
        read -p "üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç +79991234567): " PHONE_NUMBER

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å (Two-Step Verification)
        read -p "üîê –£ –≤–∞—Å –≤–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è? (y/n): " HAS_2FA
        if [[ "$HAS_2FA" == "y" || "$HAS_2FA" == "Y" ]]; then
            read -p "üîê –í–≤–µ–¥–∏—Ç–µ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å: " CLOUD_PASSWORD
        else
            CLOUD_PASSWORD=""
        fi
    else
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        API_ID=${API_ID:-""}
        API_HASH=${API_HASH:-""}
        PHONE_NUMBER=${PHONE_NUMBER:-""}
        CLOUD_PASSWORD=${CLOUD_PASSWORD:-""}

        if [ -z "$API_ID" ] || [ -z "$API_HASH" ] || [ -z "$PHONE_NUMBER" ]; then
            error_exit "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è API_ID, API_HASH –∏ PHONE_NUMBER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
        fi
    fi

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ config.json
    echo "–°–æ–∑–¥–∞–µ–º config.json..."
    cat > "$REPO_DIR/config.json" <<EOF
{
    "API_ID": "$API_ID",
    "API_HASH": "$API_HASH",
    "PHONE_NUMBER": "$PHONE_NUMBER",
    "CLOUD_PASSWORD": "$CLOUD_PASSWORD"
}
EOF
}

# =============================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ ~/.bashrc
# =============================================
setup_autostart() {
    local autostart_cmd="nohup python3 ~/rade/bot.py > ~/rade/bot.log 2>&1 &"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ ~/.bashrc, –µ—Å–ª–∏ –µ—ë —Ç–∞–º –Ω–µ—Ç
    if ! grep -qF "$autostart_cmd" ~/.bashrc; then
        echo "–î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –≤ .bashrc..."
        echo -e "\n# Telegram bot autostart\n$autostart_cmd" >> ~/.bashrc
    else
        echo "–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
}

# =============================================
# –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
# =============================================
main() {
    install_git  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º git, –µ—Å–ª–∏ –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    install_deps
    setup_repo
    get_auth_data
    setup_autostart
    
    echo -e "\n–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ë–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Termux."
    echo "–õ–æ–≥–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ ~/rade/bot.log"
}

# –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main
