#!/data/data/com.termux/files/usr/bin/bash

# =============================================
# Настройки
# =============================================
REPO_DIR="$HOME/rade"

# Зависимости Python
PYTHON_DEPS="requests telethon psutil"

# =============================================
# Функции для обработки ошибок
# =============================================
error_exit() {
    echo "ОШИБКА: $1" >&2
    exit 1
}

# =============================================
# Установка зависимостей Python
# =============================================
install_python_deps() {
    echo "-----------------------------------------"
    echo "Переходим в директорию $REPO_DIR..."
    cd "$REPO_DIR" || error_exit "Ошибка перехода в директорию репозитория"

    echo "Создаем виртуальное окружение и устанавливаем зависимости..."
    python -m venv venv || error_exit "Ошибка создания виртуального окружения"
    source venv/bin/activate || error_exit "Ошибка активации виртуального окружения"
    pip install --upgrade pip || error_exit "Ошибка обновления pip"
    
    for dep in $PYTHON_DEPS; do
        pip install "$dep" || error_exit "Ошибка установки зависимости: $dep"
    done
}

# =============================================
# Настройка автоматической активации виртуального окружения
# =============================================
setup_auto_activation() {
    echo "-----------------------------------------"
    echo "Настраиваем автоматическую активацию виртуального окружения..."

    # Добавляем активацию виртуального окружения в .bashrc
    if ! grep -q "source $REPO_DIR/venv/bin/activate" ~/.bashrc; then
        echo "source $REPO_DIR/venv/bin/activate" >> ~/.bashrc
    fi

    echo "Автоматическая активация виртуального окружения настроена."
}

# =============================================
# Главный процесс выполнения
# =============================================
main() {
    # Устанавливаем зависимости
    install_python_deps

    # Настраиваем автоматическую активацию виртуального окружения
    setup_auto_activation

    # Выводим сообщение о том, как запустить бота
    echo "========================================="
    echo "Установка завершена."
    echo "Чтобы запустить бота, выполните команду:"
    echo "   python bot.py"
    echo "========================================="
}

main
